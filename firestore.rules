rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isOwnerOfExistingDoc(userId) { return isOwner(userId) && resource != null; }
    function getUserAuthData() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function isOfficeAssistant() { return isSignedIn() && getUserAuthData().data.role == 'office_assistant'; }
    function isParticipant(appointmentData) { return isSignedIn() && (request.auth.uid == appointmentData.staffId || request.auth.uid == appointmentData.clientId); }

    // User profiles can only be read/updated by the owner. Cannot be deleted.
    match /users/{userId} {
      allow get, update: if isOwner(userId);
      allow create: if isOwner(userId);
      allow list, delete: if false;

      // User-specific subcollections for private or owned data
      match /availability_blocks/{blockId} {
        allow read, write: if isOwner(userId) || isOfficeAssistant();
      }
      match /integrations/{integrationId} {
        allow read, write: if isOwner(userId);
      }
      // A client can see their own care plan, records, and documents.
      // An office assistant can manage them for any user.
      match /care_plan_tasks/{taskId} {
        allow read, write: if isOwner(userId) || isOfficeAssistant();
      }
      match /records/{recordId} {
        allow read, write: if isOwner(userId) || isOfficeAssistant();
      }
      match /documents/{documentId} {
        allow read, write: if isOwner(userId) || isOfficeAssistant();
      }
    }

    // Appointments are managed by office assistants. Participants can view their own.
    match /appointments/{appointmentId} {
      allow get: if isParticipant(resource.data) || isOfficeAssistant();
      allow list, create, update, delete: if isOfficeAssistant();
      
      // Appointment details follow the same permissions as the parent appointment.
      match /details/{detailId} {
         allow read: if isParticipant(get(/databases/$(database)/documents/appointments/$(appointmentId)).data) || isOfficeAssistant();
         allow write: if isOfficeAssistant();
      }
    }
    
    // Document templates are public to all signed-in users. Only admins can change them.
    match /document_templates/{templateId} {
        allow get: if isSignedIn();
        allow write: if isOfficeAssistant();
    }
  }
}
